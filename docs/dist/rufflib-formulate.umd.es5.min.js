!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):((t="undefined"!=typeof globalThis?globalThis:t||self).rufflib=t.rufflib||{},t.rufflib.formulate=t.rufflib.formulate||{},t.rufflib.formulate.main=n())}(this,(function(){"use strict";function t(n){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(n)}function n(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function r(t,n){for(var r=0;r<n.length;r++){var e=n[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}function e(t,n,e){return n&&r(t.prototype,n),e&&r(t,e),Object.defineProperty(t,"prototype",{writable:!1}),t}function a(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==r)return;var e,a,i=[],c=!0,o=!1;try{for(r=r.call(t);!(c=(e=r.next()).done)&&(i.push(e.value),!n||i.length!==n);c=!0);}catch(t){o=!0,a=t}finally{try{c||null==r.return||r.return()}finally{if(o)throw a}}return i}(t,n)||c(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}
/**
   * rufflib-formulate 0.0.1
   * A RuffLIB library for transforming an object schema into an HTML form.
   * https://richplastow.com/rufflib-formulate
   * @license MIT
   */
/**
   * rufflib-validate 1.0.0
   * A RuffLIB library for succinctly validating JavaScript values.
   * https://richplastow.com/rufflib-validate
   * @license MIT
   */()}function i(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||c(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(t,n){if(t){if("string"==typeof t)return o(t,n);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?o(t,n):void 0}}function o(t,n){(null==n||n>t.length)&&(n=t.length);for(var r=0,e=new Array(n);r<n;r++)e[r]=t[r];return e}var s="array",l="boolean",u="integer",f="number",h="string",y="object",d="undefined";function m(n,r,e){var a=r.concat(e).join(".");return t(n)===d?"'".concat(a,"' of a value"):"".concat(n,".").concat(a)}function p(n,r,e){if(null===n||t(n)!==y||Array.isArray(n)){var a=b(n);return r||0!==e.length?r?0===e.length?"'".concat(r,"' is ").concat(a," not an object"):"'".concat(r,".").concat(e.join("."),"' is ").concat(a," not an object"):"'".concat(e.join("."),"' of the schema is ").concat(a," not an object"):"unnamed schema is ".concat(a," not an object")}var c=n._meta;if(null===c||t(c)!==y||Array.isArray(c)){var o=b(c);return r||0!==e.length?r?0===e.length?"'".concat(r,"._meta' is ").concat(o," not an object"):"'".concat(r,".").concat(e.join("."),"._meta' is ").concat(o," not an object"):"'".concat(e.join("."),"._meta' of the schema is ").concat(o," not an object"):"unnamed schema '._meta' is ".concat(o," not an object")}for(var m in n)if("_meta"!==m){var g=n[m];if(null===g||t(g)!==y||Array.isArray(g))return v(r,e,m,"is ".concat(b(g)," not an object"));if(g._meta){var k=p(g,r,[].concat(i(e),[m]));if(k)return k}else{if(null===g.fallback)return v(r,e,m,"is null","fallback");if(null===g.max)return v(r,e,m,"is null","max");if(null===g.min)return v(r,e,m,"is null","min");if(null===g.rule)return v(r,e,m,"is null","rule");if(null===g.set)return v(r,e,m,"is null","set");var x=Array.isArray(g.fallback)?s:t(g.fallback),N=Array.isArray(g.max)?s:t(g.max),A=Array.isArray(g.min)?s:t(g.min),w=Array.isArray(g.rule)?s:t(g.rule),_=Array.isArray(g.set)?s:t(g.set),j=x!==d,E=N!==d,S=A!==d,L=w!==d,V=_!==d,O=E+S+L+V;if(O>1&&(2!==O||!E||!S))return v(r,e,m,"has '".concat(O,"' qualifiers, only 0 or 1 allowed"));switch(g.kind){case s:return"@TODO array";case l:if(x!==l&&j)return v(r,e,m,"has '".concat(x,"' fallback, not '").concat(l,"' or '").concat(d,"'"));if(E)return v(r,e,m,"has '".concat(N,"' max, not '").concat(d,"'"));if(S)return v(r,e,m,"has '".concat(A,"' min, not '").concat(d,"'"));if(L)return v(r,e,m,"has '".concat(w,"' rule, not '").concat(d,"'"));if(V)return v(r,e,m,"has '".concat(_,"' set, not '").concat(d,"'"));break;case u:case f:if(x!==f&&j)return v(r,e,m,"has '".concat(x,"' fallback, not '").concat(f,"' or '").concat(d,"'"));if(N!==f&&E)return v(r,e,m,"has '".concat(N,"' max, not '").concat(f,"' or '").concat(d,"'"));if(A!==f&&S)return v(r,e,m,"has '".concat(A,"' min, not '").concat(f,"' or '").concat(d,"'"));if(w===y){var T=t(g.rule.test);if("function"!==T)return v(r,e,m,"has '".concat(T,"' rule.test, not 'function'"))}else if(L)return v(r,e,m,"has '".concat(w,"' rule, not '").concat(y,"' or '").concat(d,"'"));if(_===s)for(var z=0,C=g.set.length;z<C;z++){var I=t(g.set[z]);if(I!==f)return v(r,e,m,"has '".concat(I,"' set[").concat(z,"], not '").concat(f,"'"))}else if(V)return v(r,e,m,"has '".concat(_,"' set, not an array or '").concat(d,"'"));break;case h:if(x!==h&&j)return v(r,e,m,"has '".concat(x,"' fallback, not '").concat(h,"' or '").concat(d,"'"));if(N!==f&&E)return v(r,e,m,"has '".concat(N,"' max, not '").concat(f,"' or '").concat(d,"'"));if(A!==f&&S)return v(r,e,m,"has '".concat(A,"' min, not '").concat(f,"' or '").concat(d,"'"));if(w===y){var $=t(g.rule.test);if("function"!==$)return v(r,e,m,"has '".concat($,"' rule.test, not 'function'"))}else if(L)return v(r,e,m,"has '".concat(w,"' rule, not '").concat(y,"' or '").concat(d,"'"));if(_===s)for(var M=0,H=g.set.length;M<H;M++){var D=t(g.set[M]);if(D!==h)return v(r,e,m,"has '".concat(D,"' set[").concat(M,"], not '").concat(h,"'"))}else if(V)return v(r,e,m,"has '".concat(_,"' set, not an array or '").concat(d,"'"));break;default:return v(r,e,m,"not recognised","kind")}}}return null}function v(t,n,r,e,a){return"'".concat(t?t+".":"").concat(0===n.length?"":n.join(".")+".").concat(r||"").concat(a?"."+a:"","'").concat(t?"":" of the schema"," ").concat(e)}function b(n){return null===n?"null":Array.isArray(n)?"an array":"type '".concat(t(n),"'")}var g=e((function t(r,e){n(this,t),this.err=null,this.prefix=r||"(anon)",this.skip=e||!1}));g.VERSION="1.0.0",g.prototype._type=function(n,r,e){var a=t(n);if(a===e)return!0;var i="string"==typeof r?" of a value"===r.slice(-11)?r:"'".concat(r,"'"):"a value";return this.err=null===n?"".concat(this.prefix,": ").concat(i," is null not type '").concat(e,"'"):Array.isArray(n)?"".concat(this.prefix,": ").concat(i," is an array not type '").concat(e,"'"):"".concat(this.prefix,": ").concat(i," is type '").concat(a,"' not '").concat(e,"'"),!1},g.prototype._validateAgainstSchema=function(n,r,e){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];for(var i in e)if("_meta"!==i){var c=n[i],o=t(c),p=e[i];if(p._meta){if(null===c||o!==y||Array.isArray(c)){var v=m(r,a,i),b=" of a value"===v.slice(-11)?v:"'".concat(v,"'"),g=null===c?"null":o!==y?"type '".concat(o,"'"):"an array";return this.err="".concat(this.prefix,": ").concat(b," is ").concat(g," not an object"),!1}if(!this._validateAgainstSchema(c,r,p,a.concat(i)))return!1}else{var k=t(p.fallback),x=k!==d,N=o===d;if(!x||!N){var A=m(r,a,i);switch(p.kind){case s:return"@TODO array";case l:if(!this.boolean(c,A))return!1;continue;case u:case f:case h:var w=t(p.max)!==d,_=t(p.min)!==d;if(w&&_){if(!this[p.kind](c,A,p.min,p.max))return!1}else if(_){if(!this[p.kind](c,A,p.min))return!1}else if(w){if(!this[p.kind](c,A,void 0,p.max))return!1}else if(p.rule){if(!this[p.kind](c,A,p.rule))return!1}else if(p.set){if(!this[p.kind](c,A,p.set))return!1}else if(!this[p.kind](c,A))return!1;continue;default:throw this.err="oops!!",Error(this.err)}}}}return!0},g.prototype.array=function(n,r){if(this.err=null,this.skip)return!0;if(!Array.isArray(n)){var e="string"==typeof r?" of a value"===r.slice(-11)?r:"'".concat(r,"'"):"a value";return this.err=null===n?"".concat(this.prefix,": ").concat(e," is null not an array"):"".concat(this.prefix,": ").concat(e," is type '").concat(t(n),"' not an array"),!1}for(var a=arguments.length,c=new Array(a>2?a-2:0),o=2;o<a;o++)c[o-2]=arguments[o];var s=c.length;if(!s)return!0;var l=0,u=1/0,f=null,h=[],y=t(c[0]),d="function"===y?"fn":"number"===y?"num":null==c[0]?"null":"other",m=t(c[1]),p="function"===m?"fn":"number"===m?"num":null==c[1]?"null":"other",v=t(c[2]),b="function"===v?"fn":"number"===v?"num":null==c[2]?"null":"other";switch("".concat(d,",").concat(p,",").concat(b)){case"null,null,null":for(var g=3;g<s;g++)if(null!=c[g])throw this.err="Validate.array() incorrectly invoked 1: args[".concat(g,"] not nullish!"),Error(this.err);return!0;case"num,null,null":for(var k=3;k<s;k++)if(null!=c[k])throw this.err="Validate.array() incorrectly invoked 2: args[".concat(k,"] not nullish!"),Error(this.err);l=c[0];break;case"num,num,null":for(var x=3;x<s;x++)if(null!=c[x])throw this.err="Validate.array() incorrectly invoked 3: args[".concat(x,"] not nullish!"),Error(this.err);l=c[0],u=c[1];break;case"null,num,null":for(var N=3;N<s;N++)if(null!=c[N])throw this.err="Validate.array() incorrectly invoked 4: args[".concat(N,"] not nullish!"),Error(this.err);u=c[1];break;case"num,num,fn":l=c[0],u=c[1],f=c[2],h=c.slice(3);break;case"num,null,fn":l=c[0],f=c[2],h=c.slice(3);break;case"null,num,fn":u=c[1],f=c[2],h=c.slice(3);break;default:if("fn"===d)f=c[0],h=c.slice(1);else{if("num"!==d||"fn"!==p)throw this.err="Validate.array() incorrectly invoked 5: args is not one of the nine configurations!",Error(this.err);l=c[0],f=c[1],h=c.slice(2)}}if(Number.isNaN(l))throw this.err="Validate.array() incorrectly invoked: min is NaN!",Error(this.err);if(Number.isNaN(u))throw this.err="Validate.array() incorrectly invoked: max is NaN!",Error(this.err);if(n.length<l){var A=r?"'".concat(r,"'"):"array";return this.err="".concat(this.prefix,": ").concat(A," length ").concat(n.length," is < ").concat(l),!1}if(n.length>u){var w=r?"'".concat(r,"'"):"array";return this.err="".concat(this.prefix,": ").concat(w," length ").concat(n.length," is > ").concat(u),!1}if(null==f)return!0;for(var _=r||"",j=0,E=n.length;j<E;j++)if(!f.bind(this).apply(void 0,[n[j],"".concat(_,"[").concat(j,"]")].concat(i(h))))return!1;return!0},g.prototype.boolean=function(t,n){return this.err=null,!!this.skip||this._type(t,n,"boolean")},g.prototype.integer=function(t,n,r,e){if(this.err=null,this.skip)return!0;if(!this.number(t,n,r,e))return!1;if(0!=t%1){var a="string"==typeof n?" of a value"===n.slice(-11)?n:"'".concat(n,"'"):"number";return this.err="".concat(this.prefix,": ").concat(a," ").concat(t," is not an integer"),!1}return!0},g.prototype.number=function(n,r,e,a){if(this.err=null,this.skip)return!0;if(!this._type(n,r,"number"))return!1;if(Number.isNaN(n))return this.err="".concat(this.prefix,": '").concat(r,"' is NaN, not a valid number"),!1;var i="object"===t(e)&&null!=e,c="string"==typeof r?" of a value"===r.slice(-11)?r:"'".concat(r,"'"):"number";if(i&&Array.isArray(e)){if(-1!==e.indexOf(n))return!0;var o="[".concat(e,"]");return o=o.length<21?o:"".concat(o.slice(0,12),"...").concat(o.slice(-5)),this.err="".concat(this.prefix,": ").concat(c," ").concat(n," is not in ").concat(o),!1}if(i&&"function"==typeof e.test){if(e.test(n))return!0;var s="".concat(e.test);return s=s.length<21?s:"".concat(s.slice(0,12),"...").concat(s.slice(-5)),this.err="".concat(this.prefix,": ").concat(c," ").concat(n," fails ").concat(s),!1}if("number"==typeof e){var l=e;if(Number.isNaN(l))throw this.err="Validate.number() incorrectly invoked: min is NaN!",Error(this.err);if(n<l)return this.err="".concat(this.prefix,": ").concat(c," ").concat(n," is < ").concat(l),!1}if("number"==typeof a){if(Number.isNaN(a))throw this.err="Validate.number() incorrectly invoked: max is NaN!",Error(this.err);if(n>a)return this.err="".concat(this.prefix,": ").concat(c," ").concat(n," is > ").concat(a),!1}return!0},g.prototype.object=function(n,r,e){if(this.err=null,this.skip)return!0;var a=t(r)===h?" of a value"===r.slice(-11)?r:"'".concat(r,"'"):"a value";if(null===n)return this.err="".concat(this.prefix,": ").concat(a," is null not an object"),!1;if(Array.isArray(n))return this.err="".concat(this.prefix,": ").concat(a," is an array not an object"),!1;if(!this._type(n,r,"object"))return!1;if(t(e)===d)return!0;if(!this.schema(e,"schema"))throw Error("Validate.object() incorrectly invoked: ".concat(this.err));return!!this._validateAgainstSchema(n,r,e)},g.prototype.schema=function(t,n){if(this.err=null,this.skip)return!0;var r=p(t,n,[]);return!r||(this.err="".concat(this.prefix,": ").concat(r),!1)},g.prototype.string=function(n,r,e,a){if(this.err=null,this.skip)return!0;if(!this._type(n,r,"string"))return!1;var i="object"===t(e)&&null!=e,c="string"==typeof r?" of a value"===r.slice(-11)?r:"'".concat(r,"'"):"string";if(i&&Array.isArray(e)){if(-1!==e.indexOf(n))return!0;var o='"'.concat(n,'"');o=o.length<21?o:"".concat(o.slice(0,12),"...").concat(o.slice(-5));var s="[".concat(e,"]");return s=s.length<21?s:"".concat(s.slice(0,12),"...").concat(s.slice(-5)),this.err="".concat(this.prefix,": ").concat(c," ").concat(o," is not in ").concat(s),!1}if(i&&"function"==typeof e.test){if(e.test(n))return!0;var l='"'.concat(n,'"');l=l.length<21?l:"".concat(l.slice(0,12),"...").concat(l.slice(-5));var u="".concat(e instanceof RegExp?e:e.test);return u=u.length<21?u:"".concat(u.slice(0,12),"...").concat(u.slice(-5)),this.err="".concat(this.prefix,": ").concat(c," ").concat(l," fails ").concat(u),!1}if("number"==typeof e){var f=e;if(Number.isNaN(f))throw this.err="Validate.string() incorrectly invoked: min is NaN!",Error(this.err);if(n.length<f)return this.err="".concat(this.prefix,": ").concat(c," length ").concat(n.length," is < ").concat(f),!1}if("number"==typeof a){if(Number.isNaN(a))throw this.err="Validate.string() incorrectly invoked: max is NaN!",Error(this.err);if(n.length>a)return this.err="".concat(this.prefix,": ").concat(c," length ").concat(n.length," is > ").concat(a),!1}return!0};var k="sg-";function x(t){t.classList.contains("".concat(k,"min"))?function(t){for(var n=1,r=0,e=t.childNodes.length;r<e;r++){var a=t.childNodes[r];N(a)?n+=a.style.height.slice(0,-2)/30:w(a)&&(n+=1)}t.style.height="".concat(30*n,"px"),t.classList.remove("".concat(k,"min"));var i=t.parentNode;_(i)&&A(i)}(t):function(t){t.style.height="30px",t.classList.add("".concat(k,"min"));var n=t.parentNode;_(n)&&A(n)}(t)}function N(t){return t.classList.contains("".concat(k,"fieldset"))}function A(t){for(var n=N(t)?1:0,r=0,e=t.childNodes.length;r<e;r++){var a=t.childNodes[r];N(a)?n+=a.style.height.slice(0,-2)/30:w(a)&&(n+=1)}t.style.height="".concat(30*n,"px");var i=t.parentNode;_(i)&&A(i)}function w(t){return t.classList.contains("".concat(k,"row"))}function _(t){return N(t)||function(t){return t.classList.contains("".concat(k,"form"))}(t)}function j(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sg",e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if("object"!==t(n._meta)||null==n._meta)throw Error("schema._meta is '".concat(n._meta,"' not an object"));if("string"!=typeof n._meta.title)throw Error("schema._meta.title is '".concat(t(n._meta.title),"' not 'string'"));if(!/^[-_ 0-9a-z]{1,32}$/i.test(n._meta.title))throw Error("schema._meta.title '".concat(n._meta.title,"' fails /^[-_ 0-9a-z]{1,32}$/i"));var c=n._meta.title,o=[],s={kind:"fieldsetDown",title:c};s.id=r,o.push(s);var l=1;for(var u in n){var f=n[u];if("object"!==t(f)||null===f)throw Error("!");if("_meta"!==u)if(f.kind){if(!/^[_a-z][_a-z0-9]*$/.test(u))throw Error("".concat(u," fails /^[_a-z][_a-z0-9]"));f.identifier=u,f.id="".concat(r,"-").concat(u),o.push(f),l++}else{var h=j(f,"".concat(r,"-").concat(u),e+1),y=a(h,2),d=y[0],m=y[1];l+=d,o.push.apply(o,i(m))}}return s.depth=e,s.height=l,o.push({kind:"fieldsetUp"}),[l,o]}function E(t){var n=document.createElement("label");n.id=t.id,n.classList.add("".concat(k,"row"),"".concat(k,"boolean"));var r=document.createElement("span");r.innerHTML=t.identifier,n.appendChild(r);var e=document.createElement("input");return e.type="checkbox",e.checked=t.initially,n.appendChild(e),n}function S(t){var n=document.createElement("fieldset");n.id=t.id,n.classList.add("".concat(k,"fieldset"),"".concat(k,"depth-").concat(t.depth)),n.style.height="".concat(30*t.height,"px");var r=document.createElement("div");r.classList.add("".concat(k,"title")),n.appendChild(r);var e=document.createElement("span");return e.classList.add("".concat(k,"arrow")),e.innerText="➤",r.appendChild(e),r.innerHTML+=" ".concat(t.title),n}var L=function(){function t(r,e,i){n(this,t);var c=new g("new Formulate()",!1);if(!(r instanceof HTMLElement))return this.err="myFunction(): '$container' is not an HTMLElement";if(!c.string(e,"identifier",/^[_a-z][_0-9a-z]*$/))return this.err=c.err;if(!c.schema(i,"schema"))return this.err=c.err;this.$container=r,this.identifier=e,this.schema=i;var o=a(j(i,e),2),s=o[0],l=o[1];this.height=s,this.steps=l,function(t,n){t.innerHTML="";for(var r=[t],e=0,a=n.length;e<a;e++){var i=n[e],c=r[r.length-1];switch(i.kind){case"fieldsetDown":var o=S(i);c.appendChild(o),r.push(o);break;case"fieldsetUp":r.pop();break;case"boolean":c.appendChild(E(i));break;default:throw Error("steps[".concat(e,"].kind '").concat(i.kind,"' not recognised"))}}t.addEventListener("click",(function(t){var n=t.target;n.id||(n=n.parentNode),n.id||(n=n.parentNode),N(n)&&x(n)}))}(r,l),r.style.height="".concat(30*s,"px")}return e(t,[{key:"toObject",value:function(){return{height:this.height,schema:this.schema,steps:this.steps}}}],[{key:"boolean",value:function(t){return{initially:t,kind:"boolean"}}}]),t}();return L.VERSION="0.0.1",L}));
